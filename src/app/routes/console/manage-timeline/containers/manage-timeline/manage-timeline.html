<div class="flex flex-col h-full">
  <div
    class="sticky top-0 z-10 flex items-center justify-between min-h-[5rem] px-[1.25rem] border-b border-neutral-200 bg-white"
  >
    <h1 class="text-2xl font-semibold text-neutral-800">Parcours</h1>

    <button (click)="openPanel()" matButton="filled">
      <mat-icon>add</mat-icon>
      Ajouter un nouvel élément
    </button>
  </div>

  <div class="flex flex-col flex-1 gap-[1.5rem] bg-neutral-100 p-[1.25rem]">
    @if (timelineStore.loading()) {
      <div class="text-center p-8 text-base font-medium text-neutral-600">Chargement de la timeline...</div>
    }

    <div class="w-full max-w-[1400px] mx-auto p-4">
      <div class="timeline">
        @for (item of timelineStore.filteredItems(); track item.id; let isEven = $even) {
          <app-timeline-item
            [item]="item"
            [isLeft]="isEven"
            (editRequested)="onEditRequested($event)"
            (deleteRequested)="onDeleteRequested($event)"
            (detachRequested)="onDetachRequested($event)"
          />
        }
      </div>
    </div>
  </div>
</div>

<app-side-panel (closed)="onCloseRequested()" [isOpen]="panelOpen()">
  <div class="h-full flex flex-col">
    <div class="shrink-0 mb-6">
      <mat-form-field appearance="outline" class="w-full">
        <mat-select [formControl]="typeControl" class="unified-field" placeholder="Catégorie">
          @for (t of types; track t) {
            <mat-option [value]="t" class="flex items-center gap-2">
              <mat-icon
                fontIcon="{{ typeMeta[t].icon }}"
                [style.color]="typeMeta[t].color"
                class="mr-2 align-middle"
              ></mat-icon>
              {{ typeMeta[t].label }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="flex-1">
      @switch (selectedType()) {
        @case (TimelineItemType.Job) {
          <app-job-form [job]="null" (saved)="onCloseRequested()"/>
        }
        @case (TimelineItemType.Education) {
          <app-education-form [education]="null" (saved)="onCloseRequested()"/>
        }
        @case (TimelineItemType.Project) {
          <app-project-timeline-link (created)="onCloseRequested()"/>
        }
        @case (TimelineItemType.Other) {
          <app-other-timeline-item-create (created)="onCloseRequested()"/>
        }
        @default {
          <div class="text-slate-500 text-sm">
            Choisis une catégorie pour afficher le formulaire correspondant.
          </div>
        }
      }
    </div>
  </div>
</app-side-panel>

<app-side-panel (closed)="onEditEducationCloseRequested()" [isOpen]="editEducationPanelOpen()">
  <div class="h-full flex flex-col">
    <app-education-form [education]="educationToEdit()" (saved)="onEditEducationCloseRequested()"/>
  </div>
</app-side-panel>

<app-side-panel (closed)="onEditJobCloseRequested()" [isOpen]="editJobPanelOpen()">
  <app-job-form [job]="jobToEdit()" (saved)="onEditJobCloseRequested()"/>
</app-side-panel>

<app-confirmation-modal
  [isOpen]="deleteModalOpen()"
  [title]="itemToDelete()?.type === TimelineItemType.Education ? 'Supprimer la formation' : 'Supprimer l\'expérience'"
  [message]="itemToDelete()?.type === TimelineItemType.Education ? 'Êtes-vous sûr de vouloir supprimer cette formation ?' : 'Êtes-vous sûr de vouloir supprimer cette expérience ?'"
  [isDelete]="true"
  [confirmLabel]="'Supprimer'"
  (confirmed)="onDeleteConfirmed()"
  (cancelled)="onDeleteCancelled()"
/>

<app-confirmation-modal
  [isOpen]="detachModalOpen()"
  [title]="'Détacher le projet'"
  [message]="'Êtes-vous sûr de vouloir détacher ce projet de la timeline ?'"
  [isDelete]="false"
  [confirmLabel]="'Détacher'"
  (confirmed)="onDetachConfirmed()"
  (cancelled)="onDetachCancelled()"
/>
