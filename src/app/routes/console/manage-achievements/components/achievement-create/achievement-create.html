<form [formGroup]="form" (submit)="addAchievement()" class="w-full h-full flex flex-col justify-between">
  <div class="flex flex-col gap-4">
    <div class="flex gap-2 items-start">
      <div class="relative">
        <input type="color" formControlName="color"
               class="absolute inset-0 opacity-0 cursor-pointer w-[2.5rem] h-[2.5rem]"/>
        <div class="w-[2.5rem] h-[2.5rem] rounded-lg border-2 border-neutral-300 cursor-pointer"
             [style.background-color]="colorCtrl.value"></div>
      </div>

      <div class="relative flex-1">
        <div class="flex gap-1 items-start">
          <mat-form-field
            appearance="outline"
            class="icon-selector-field"
            [class.icon-selected]="selectedIcon()"
            [style.--icon-color]="colorCtrl.value"
          >
            @if (selectedIcon()) {
              <mat-icon matIconPrefix class="icon-colored">{{ selectedIcon() }}</mat-icon>
            }
            <input
              matInput
              type="text"
              placeholder="Rechercher une icône"
              formControlName="icon"
              autocomplete="off"
              (focus)="showPanel.set(true)"
              (blur)="onBlur()"
              [readonly]="!!selectedIcon()"
            />
          </mat-form-field>

          @if (selectedIcon()) {
            <button
              type="button"
              mat-icon-button
              class="!h-[2.5rem] !w-[2.5rem] !min-w-0"
              (click)="clearIcon()"
            >
              <mat-icon class="!text-[1.25rem]">close</mat-icon>
            </button>
          }
        </div>

        @if (showPanel() && filteredIcons().length > 0) {
          <div
            class="absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg border border-neutral-200 p-2 max-h-[25rem] overflow-y-auto">
            <div class="grid grid-cols-5 gap-2">
              @for (name of filteredIcons(); track name) {
                <button
                  type="button"
                  class="flex flex-col items-center justify-center gap-1 p-2 rounded-lg hover:bg-neutral-100 transition-colors min-h-[4rem]"
                  (mousedown)="selectIcon(name)"
                >
                  <mat-icon [fontIcon]="name" class="!text-[1.5rem] !w-[1.5rem] !h-[1.5rem]"
                            [style.color]="colorCtrl.value"></mat-icon>
                  <span
                    class="text-xs text-neutral-600 text-center w-full overflow-hidden text-ellipsis whitespace-nowrap">{{ name }}</span>
                </button>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <mat-form-field appearance="outline" class="w-full">
      <input matInput formControlName="code" placeholder="Code du succès (5 caractères max)" maxlength="5"
             (input)="onCodeInput()"/>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full">
      <input matInput formControlName="label" placeholder="Titre du succès"/>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full">
      <textarea matInput formControlName="description" rows="3" placeholder="Description du succès"></textarea>
    </mat-form-field>

    <div class="flex items-center gap-3 p-3 rounded-lg bg-neutral-50 border border-neutral-200">
      <mat-slide-toggle formControlName="isActive"
                        [color]="form.get('isActive')?.value ? 'primary' : 'warn'"></mat-slide-toggle>
      <div class="flex flex-col">
        <span class="text-sm font-medium" [class.text-green-600]="form.get('isActive')?.value"
              [class.text-red-600]="!form.get('isActive')?.value">
          {{ form.get('isActive')?.value ? 'Succès activé' : 'Succès désactivé' }}
        </span>
        <span class="text-xs text-neutral-600">
          {{ form.get('isActive')?.value ? 'Les visiteurs peuvent débloquer ce succès' : 'Ce succès ne sera pas accessible' }}
        </span>
      </div>
    </div>
  </div>

  <div class="flex justify-end gap-3 mt-4">
    <button type="submit" matButton="filled" [disabled]="form.invalid">
      <mat-icon>add</mat-icon>
      Créer
    </button>
  </div>
</form>
