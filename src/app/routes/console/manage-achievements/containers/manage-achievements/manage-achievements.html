<div class="flex flex-col h-full">
  <div
    class="sticky top-0 z-10 flex items-center justify-between min-h-[5rem] px-[1.25rem] border-b border-neutral-200 bg-white"
  >
    <h1 class="text-2xl font-semibold text-neutral-800">Achievements</h1>

    <button (click)="openPanel()" matButton="filled">
      <mat-icon>add</mat-icon>
      Créer un succès
    </button>
  </div>

  <main class="flex flex-col flex-1 gap-6 bg-neutral-100 p-5 overflow-auto">
    <section class="grid gap-6 grid-cols-2 xl:grid-cols-4">
      <app-kpi-card
        title="Total Succès"
        [value]="facade.achievementsTotal()"
        icon="emoji_events"
        color="#ebb207"/>

      <app-kpi-card
        title="Actifs"
        [value]="totalActiveAchievements()"
        icon="check_circle"
        color="#21c45d"/>

      <app-kpi-card
        title="Total Débloqués"
        [value]="achievementStats()!.totalUnlocked"
        icon="lock_open"
        color="#3b82f5"/>

      <app-kpi-card
        title="Taux Complétion"
        [value]="achievementStats()!.completionRate"
        icon="pie_chart"
        color="#a854f7"
        [isPercent]="true"/>
    </section>

    @if (achievements().length > 0) {
      <section
        class="grid gap-6 grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 transition-opacity"
        [class.opacity-50]="facade.achievementsIsLoading()"
        role="list"
      >
        @for (achievement of achievements(); track achievement.id) {
          <app-achievement-item
            [achievement]="achievement"
            (edit)="onEdit($event)"
            (remove)="onRemove($event)"/>
        }
      </section>

      <footer class="flex items-center justify-between mt-6 px-6 h-14 bg-white rounded-lg border border-slate-200">
        <p class="text-sm text-slate-600">
          Affichage
          <span class="font-medium text-slate-900">
            {{ facade.achievementsStartIndex() }} - {{ facade.achievementsEndIndex() }}
          </span>
          sur
          <span class="font-medium text-slate-900">{{ facade.achievementsTotal() }}</span>
          succès
        </p>

        <app-pagination
          [currentPage]="facade.achievementsPage()"
          [totalPages]="facade.achievementsTotalPages()"
          [isLoading]="facade.achievementsIsLoading()"
          (pageChange)="facade.setAchievementsPage($event)"
          (previousPage)="facade.previousAchievementsPage()"
          (nextPage)="facade.nextAchievementsPage()"
        />
      </footer>
    } @else {
      <div class="flex items-center justify-center flex-1">
        <p class="text-gray-500">Aucun succès disponible</p>
      </div>
    }
  </main>
</div>

<app-side-panel (closed)="onCloseRequested()" [isOpen]="panelOpen()">
  <app-achievement-form [achievement]="selectedAchievement()" (saved)="onCloseRequested()"/>
</app-side-panel>

@if (confirmModalOpen()) {
  <app-confirmation-modal
    [isOpen]="confirmModalOpen()"
    title="Supprimer le succès"
    [message]="deletionMessage()"
    [isDelete]="true"
    (confirmed)="confirmDelete()"
    (cancelled)="cancelDelete()"
  />
}
